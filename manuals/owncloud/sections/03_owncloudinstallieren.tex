\section{ownCloud installieren}
Nachdem das Betriebssystem erfolgreich auf die SD-Karte geladen werden konnt und alle Kabel und Komponenten angeschlossen sind, kann mit der eigentlichen Installation von ownCloud begonnen werden.

\subsection{Betriebssystem starten}
Beim ersten Start des Raspberry öffnet sich nach kurzer Wartezeit ein graues Fenster auf blauem Hintergrund mit dem Titel ``Raspberry Pi Software Configuration Tool". 

\begin{figure}[h]
\centering
\includegraphics[scale=0.5]{images/raspiconfig}
\caption{Raspberry Pi Konfigurations-Tool}
\end{figure}

Dieses Werkzeug dient dazu, gewisse Grundeinstellungen vorzunehmen. Folgende Einstellungen sollten vorgenommen werden: 

\begin{enumerate}
\item Benutzerpasswort ändern (Change User Password)
\item Ausweiten des Dateisystems, um den Speicher der Karte voll auszunutzen (Expand Filesystem)
\item Standardumgebung einstellen auf ``Console Text console" (Enable Booot to Desktop/Scratch)
\item Anpassen des Keyboardlayouts (Internationalisation Options > Change Keyboard Layout)
\item Regionaleinstellungen auf en\_US.UTF-8 setzen (Internationalisation Options > Change Locale)
\item Zeitregion setzen (Internationalisation Options > Change Timezone) 
\item Raspberry Pi übertakten auf "Medium, 900MHz" (Overclock)
\item Speicherverteilung für die GPU auf 16 begrenzen (in Megabyte, MB) (Advanced Options > A3 Memory Split)
\end{enumerate}

Sollte es mit den getroffenen Einstellungen zu Problemen kommen, kann das Konfigurationstool im laufenden Betrieb erneut aufgerufen werden. Folgender Befehl muss dazu in der Konsole eingegeben werden: 

\begin{lstlisting}
sudo raspi-config
\end{lstlisting} 

Sind alle Einstellungen vorgenommen, kann das Menü mittels ``Finish" verlassen werden. Die Frage, ob neu gestartet werden soll (reboot), mit "Ja" beantworten, worauf das System neu startet und alle zuvor vorgenommenen Einstellungen übernommen werden.
\\
\\
Nach dem Neustart findet man sich in einem konsolenartigen Fenster mit einem blinkenden Cursor wieder. Dies wird für den Rest des Tutorials die Arbeitsumgebung sein, da die grafische Benutzeroberfläche nicht gebraucht wird. Die Performance ist in der Konsole zudem deutlich besser.

\subsection{Root-Rechte erlangen}
Die meisten der in dieser Anleitung beschriebenen Befehle verlangen erweiterte Rechte. Diese können unter Raspbian ganz einfach erlangt werden mittels:

\begin{lstlisting}
sudo su
\end{lstlisting}

Grosse Macht bringt auch grosse Verantwortung. Hat man unter Linux Administrator-Rechte (auch Root-Rechte), kann man sehr schnell sehr vieles kaputt machen. Im schlimmsten Fall muss die SD-Karte neu aufgesetzt werden. Es lohnt sich deshalb, ein paar wenige Regeln zum Gebrauch der Konsole zu beachten: 

\begin{itemize}
\item Ein Befehl wird mittels Drücken der ``Enter-Taste" abgesetzt
\item Bevor ein neuer Befehl abgsetzt werden, muss der zuvor eingegebene abgeschlossen sein (manchmal ist Geduld gefragt)
\item Gross- und Kleinschreibung werden unter Linux unterschieden!
\item Immer sicherstellen, dass der Befehl auch wirklich richtig eingegeben wurde
\end{itemize}

\subsection{System aktualisieren}
Um sicher zu stellen, dass das System auf dem aktuellsten Stand ist, müssen zuerst alle installierten Pakete aktualisiert werden. Dazu müssen folgende zwei Befehle abgesetzt werden:

\begin{lstlisting}
apt-get update
apt-get upgrade
\end{lstlisting}

Nach der Eingabe von ``apt-get upgrade" fragt das Terminal noch einmal nach, ob man die neuen, zur Verfügung stehenden Pakete wirklich installieren will. Standardmässig ist die Antwort auf "Ja" eingestellt, was man an dem grossen Y in [Y/n] erkennt. Um fortzufahren reicht ein erneutes Drücken der ``Enter-Taste". Zukünftige Rückfragen bei abgesetzten Befehlen können auf die gleiche Weise behandelt werden. Es empfiehlt sich dennoch, die angezeigte Meldungen (Informationen, Warnungen) immer durchzulesen und entsprechend zu handeln.

\begin{figure}[h]
\centering
\includegraphics[scale=0.7]{images/upgrade}
\caption{apt-get upgrade}
\end{figure}

\subsection{Abhänigkeiten installieren}
Damit ownCloud reibungslos laufen kann, müssen einige zusätzliche Pakete installiert werden.
\\
Wir benötigen:

\begin{itemize}
\item Apache2 \\
Apache2 ist ein freier Webserver. Als Webserver wird ein Dienst bezeichnet, welcher Anfragen über das Web empfangen und beantworten kann. Ein Webbrowser - beispielsweise Mozilla FireFox - ist das Gegenstück zum Webserver. Er ist derjenige, der die Anfragen an den Server sendet. In unserem Fall ist die Aufgabe von Apache2, das installierte ownCloud für einen Client erreichbar zu machen.
\item PHP5 \\
ownCloud wurde mit der Scriptsprache PHP programmiert. Die PHP-Komponente (PHP5) muss zusätzlich zu Apache installiert werden, damit ownCloud als Anwendung überhaupt ausgeführt werden kann.
\item SQLite \\
Um all die Benutzerdaten, wie Benutzername und Passwort, zu speichern braucht es eine Datenbank. Diese stellt SQLite zur Verfügung.
\end{itemize}

Der folgenden Befehl kann entweder kopiert und ins Terminal eingefügt oder aber abgetippt werden. Je nach verwendetem PDF-Betrachter, muss auf die 2. Methode zurückgegriffen werden:

\begin{lstlisting}
sudo apt-get install apache2 php5 php5-gd php5-sqlite php5-curl php5-json php5-common php5-intl php-pear php-apc php-xml-parser libapache2-mod-php5 curl libcurl3 libcurl3-dev sqlite
\end{lstlisting}

\subsection{Statische IP-Adresse}
Die IP-Adresse, durch welche der Computer im Netz eindeutig identifiziert werden kann und über welche letztendlich der Zugriff auf die Cloud erfolgen wird, kann nach jedem Computerstart anders aussehen.
Aus diesem Grund ist es sinnvoll, die IP-Adresse statisch festzulegen.
\\
\\
Zuerst muss die Netwerkkonfigurationsdatei unter ``/etc/network/interfaces'' angepasst werden.
\\
Dazu muss man die Datei mit einem Texteditor öffnen. Dazu kann der vorinstallierte Texeditor ``Nano" verwendet werden: 

\begin{lstlisting}
sudo nano /etc/network/interfaces
\end{lstlisting} 

\begin{figure}[h]
\centering
\includegraphics[scale=0.6]{images/nano}
\caption{Texteditor Nano}
\end{figure}

Unter Umständen kann es vorkommen, dass folgende Zeile bereits in der Datei steht:

\begin{lstlisting}
iface eth0 inet dhcp
\end{lstlisting}

Sofern dies der Fall ist, muss diese gelöscht und durch folgende Zeilen ersetzt werden:

\begin{lstlisting}
iface eth0 inet static
address 192.168.1.107
netmask 255.255.255.0
gateway 192.168.1.1
network 192.168.1.0
broadcast 192.168.1.255
\end{lstlisting}

Die verwendete IP-Adresse in der zweiten Zeile (192.168.1.107) sollte durch die aktuelle IP-Adresse des Systems ersetzt werden. Diese kann mit dem Kommando ``ifconfig'' ermittelt werden. Sie steht auf der zweiten Zeile bei ``eth0" unter ``inet addr:".

\begin{figure}[h]
\centering
\includegraphics[scale=0.65]{images/ifconfig}
\caption{Ausgabe von ifconfig}
\end{figure}

Nun muss das Interface (eth0) noch neu gestartet werden, damit die Änderungen wirksam werden:

\begin{lstlisting}
ifdown eth0
ifup eth0
\end{lstlisting}

\subsection{Webserver-Benutzer anlegen}
Aus Sicherheitsgründen sollte ein Webserver immer von einem Benutzer mit eingeschränkten Rechten ausgeführt werden. Er soll nur auf jene Dateien zugreifen können, die er auch wirklich braucht. Dazu legt man einen Benutzer namens ``www-data' an und fügt ihn anschliessend der gleichnamigen Gruppe zu:

\begin{lstlisting}
groupadd www-data
usermod -a -G www-data www-data
\end{lstlisting}

Nach dem Befehl ``groupadd" wird unter Umständen eine Meldung angezeigt, dass die angegebene Gruppe ``www-data" bereits existiert. In diesem Fall einfach mit dem zweiten Befehl weiterfahren.

\subsection{Webserver konfigurieren}
Als Webserver wird apache2 verwendet. Dieser wurde bereits im Abschnitt ``Abhängigkeiten installieren" installiert. Er muss jetzt lediglich noch so eingerichtet werden, dass ownCloud darauf laufen kann.
\\
\\
Apache verlangt beim Start zu wissen, wie der Webserver heisst. Man hat hier freie Wahl, sollte aber etwas Sinnvolles eingeben, wie beispielsweise ``owncloud".
\\
Jetzt muss der Name der Konfigurationsdatei von Apache hinzgefügt werden:

\begin{lstlisting}
echo "ServerName owncloud" >> /etc/apache2/apache2.conf
\end{lstlisting}

Auch dem System selbst muss dieser Namen bekannt gegeben werden. Folgender Befehl fügt die entsprechende Zeile der Datei ``/etc/hosts" hinzu:

\begin{lstlisting}
echo "127.0.0.1 ownloud" >> /etc/hosts
\end{lstlisting}

Damit owncloud korrekt ausgeführt werden darf, müssen ihm noch gewisse Rechte eingeräumt werden. Dazu öffnet man die Apache Konfigurationsdatei ``/etc/apache2/sites-enabled/000-default" mit einem Texteditor (hier wiederum Nano):

\begin{lstlisting}
nano /etc/apache2/sites-enabled/000-default
\end{lstlisting}

Und sucht nach folgendem Abschnitt:

\begin{lstlisting}
<Directory /var/www/>
  Options Indexes FollowSymLinks MultiViews
  AllowOverride None
  Order allow,deny
  allow from all
</Directory>
\end{lstlisting}

Die Zeile ``AllowOverride None'' einfach mit ``AllowOverride All'' ersetzen. Zum Schluss müssen noch ein paar zusätzliche Module für den Webserver installiert werden:

\begin{lstlisting}
a2enmod rewrite
a2enmod headers
\end{lstlisting}

\subsection{Webserver absichern}
Ein grosses Thema in Sachen Cloud ist die Sicherheit. Die zukünftige Cloud soll dabei nicht zu kurz kommen, weshalb der Webserver mit HTTPS\footnote{\url{http://de.wikipedia.org/wiki/Https}} ausgestattet wird.
\\
\\
Zuerst muss ein Zertifikat mit Schlüssel generiert werden. Anschliessend wird dieses in ein bestimmtes Verzeichnis abgelegt, damit der Webserver es auch finden kann.
\\
Folgende Befehle müssen dazu der Reihe nach abgesetzt werden:

\begin{lstlisting}
mkdir -p /etc/apache2/ssl

openssl req -new -x509 -days 365 -nodes -out /etc/apache2/ssl/apache.pem -keyout /etc/apache2/ssl/apache.pem

ln -sf /etc/apache2/ssl/apache.pem /etc/apache2/ssl/`/usr/bin/openssl x509 -noout -hash < /etc/apache2/ssl/apache.pem`

chmod 600 /etc/apache2/ssl/apache.pem
\end{lstlisting}

Nach der Erstellung des Zertifikates muss das Modul geladen werden, welches der ownCloud SSL (HTTPS) zur Verfügung stellt:

\begin{lstlisting}
a2enmod ssl
\end{lstlisting}

Nun muss das das Verzeichnis ``/var/www" noch mit SSL verknüpft werden. Dazu öffnet man folgende Datei mit einem Texteditor: 

\begin{lstlisting}
nano /etc/apache2/sites-available/ssl
\end{lstlisting}

Und fügt folgende Zeilen hinzu: 

\begin{lstlisting}
<virtualhost *:443>
  SSLEngine On
  SSLCertificateFile /etc/apache2/ssl/apache.pem
  DocumentRoot /var/www  
</virtualhost>" 
\end{lstlisting}

Anschliessend wird die vorgenommene Konfiguration noch aktiviert:

\begin{lstlisting}
a2ensite ssl
\end{lstlisting}

\subsection{PHP konfigurieren}
Die PHP-Komponente des Webservers muss ebenfalls angepasst werden. Sie hat standardmässig ein Sicherheitslimit gesetzt, welches die Uploadgrösse einer Datei einschränkt. Dieses soll nun aber erhöht werden, damit der Anwender der Cloud in der Lage ist, Dateien hochzuladen, die grösser als 2 Megabyte sind. In diesem Beispiel wird das Limit von 2MB (Megabyte) bzw. 8MB auf 2GB (Gigabyte) gesetzt.
\\

\begin{lstlisting}
sed -i 's/upload_max_filesize = 2M/upload_max_filesize = 2G/' /etc/php5/apache2/php.ini

sed -i 's/post_max_size = 8M/post_max_size = 2G/' /etc/php5/apache2/php.ini
\end{lstlisting}

\subsection{ownCloud installieren}
Jetzt ist der Webserver bereit, um ownCloud zu installieren. Zuerst muss die neuste Version von ownCloud heruntergeladen werden. Um herauszufinden, welches die neuste Version ist, besucht man am besten die offizielle Homepage\footnote{\url{https://owncloud.org/}} oder Wikipedia. Zur Zeit ist Version 6.0.1 die aktuellste. Sie kann wie folgt direkt aus dem Terminal heruntergeladen werden:

\begin{lstlisting}
cd
wget http://download.owncloud.org/community/owncloud-6.0.1.tar.bz2 -O owncloud.tar.bz2
\end{lstlisting}

Nun muss das heruntergeladene Archiv noch entpackt und die Dateien in den Ordner ``/var/www" verschoben werden. Dieser Ordner ist standardmässig der vom Webserver benutzte.

\begin{lstlisting}
tar xvf owncloud.tar.bz2
rm -f /var/www/index.html
mv owncloud/* /var/www
mv owncloud/.htaccess /var/www
rm -rf owncloud owncloud.tar.bz2
\end{lstlisting}

Damit der zuvor erstellte Benutzer ``www-data" auch auf diese Dateien zugreifen kann, müssen ihm noch die entsprechenden Rechte gegeben werden:

\begin{lstlisting}
chown -R www-data:www-data /var/www
\end{lstlisting}

\subsection{Speicher erweitern}
Da die verwendete SD-Karte eine eher kleine Kapazität hat, lohnt es sich, ownCloud mehr Speicher zur Verfügung zu stellen. Man kann dazu eine externe Festplatte per USB oder alternativ einen USB-Stick an den Raspberry anschliessen und anschliessend konfigurieren.
\\
\\
Zuerst muss man den Namen des Angeschlossenen Speichergerätes herausfinden: 

\begin{lstlisting}
blkid
\end{lstlisting}

Dieser Befehl gibt alle angeschlossenen Speichergeräte an. Wenn neben der SD-Karte lediglich ein zusätzliche Speichergerät angeschlossen wurde, müsste dieses als drittes aufgeführt sein mit der Bezeichnung ``dev/sda1".

\subsubsection{Separater Speicher}
Wird ein neues oder leeres Speichergerät verwendet, muss es zuerst neu formatiert werden (hier mit dem Dateisystem ext4).
\\Achtung: Dies löscht alle auf dem Speichergerät vorhandenen Daten!
\\
\begin{lstlisting}
mkfs.ext4 /dev/sda1
\end{lstlisting}

Dieser Schritt kann auch weggelassen werden. Es ist aber grundsätzlich empfohlen, für ownCloud ein separates Speichergerät zu verwenden.

\subsubsection{Automatisches Einbinden}
Damit die Festplatte bei jedem Neustart automatisch eingebunden (aktiviert) wird und zur Verfügung steht, muss das System dementsprechend konfiguriert werden. 
\\
\\
Zuerst wird das Verzeichnis erstellt, unter dem das Speichergerät später eingebunden wird und zur Verfügung steht:

\begin{lstlisting}
mkdir -p /mnt/ownclouddata
\end{lstlisting}

Dann muss der Typ des auf dem Speichergerät verwendeten Dateisystems ermittelt werden:

\begin{lstlisting}
blkid /dev/sda1
\end{lstlisting}

Den Wert nach TYPE zwischen den Anführungszeichen muss man sich merken. Es handelt sich um den Namen des verwendeten Dateisystems auf dem Datenträger (z.B. ext4).
Bevor der nachfolgenden Befehl ausgeführt werden kann, muss das Wort TYPE durch den vorhin gemerkten Wert - das verwendete Dateisystems - ersetzt werden.

\begin{lstlisting}
echo "/dev/sda1 /mnt/ownclouddata TYPE defaults 0 0" >> /etc/fstab
\end{lstlisting}

Nun müssen noch die Festplatte in das System eingebunden und dem Benutzer ``www-data" die entsprechenden Rechte gegeben werden:

\begin{lstlisting}
mount -a
chown -R www-data:www-data /mnt/ownclouddata
\end{lstlisting}

\subsection{Webserver neustarten}
Zu guter letzt muss der Webserver neu gestartet werden, damit all die getätigten Änderungen auch wirksam werden:

\begin{lstlisting}
service apache2 restart
\end{lstlisting}

Nun ist ownCloud fertig installiert und kann eingerichtet werden.