\section{ownCloud einrichten}
Nachdem das Betriebssystem erfolgreich auf dem Raspberry Pi aufgesetzt werden konnte und alle Kabel und Komponenten angeschlossen sind, kann mit der eigentlichen Installation von ownCloud begonnen werden.

\subsection{Betriebssystem starten}
Beim ersten Start des Raspberry öffnet sich nach kurzer Wartezeit ein graues Fenster auf blauem Hintergrund mit dem Titel ``Raspberry Pi Software Configuration Tool". 

% FIXME: Bild von config tool

Dies dient dazu, gewisse Grundeinstellungen vorzunehmen. Folgende Konfigurationen sollten vorgenommen werden: 

\begin{enumerate}
\item Benutzerpasswort ändern (Change User Password)
\item Ausweiten des Dateisystems, um den Speicher der Karte voll auszunutzen (Expand Filesystem)
\item Standardumgebung einstellen auf ``Console Text console" (Enable Booot to Desktop/Scratch)
\item Anpassen des Keyboardlayouts (Internationalisation Options > Change Keyboard Layout)
\item Regionaleinstellungen auf en\_US.UTF-8 setzen (Internationalisation Options > Change Locale)
\item Zeitregion setzen (Internationalisation Options > Change Timezone) 
\item Raspberry Pi übertakten auf "Medium, 900MHz" (Overclock)
\item Speicherverteilung für die GPU auf 16 (MB) begrenzen (Advanced Options > A3 Memory Split)
\end{enumerate}

Sollte es mit den getroffenen Einstellungen zu Problemen kommen, kann das Konfigurationstool im laufenden Betrieb erneut aufgerufen. Folgender Befehl muss dazu im Terminal eingegeben werden: 

\begin{lstlisting}
sudo raspi-config
\end{lstlisting} 

Sind alle Einstellungen vorgenommen, kann das Menü mittels ``Finish" verlassen werden. Die Frage, ob neu gestartet (reboot) werden soll, muss bestätigt werden, worauf das System neu startet und alle zuvor vorgenommenen Einstellungen übernommen werden.
\\
Nach dem Neustart findet man sich in einem konsolenartigen Fenster mit einem blinkenden Cursor wieder. Dies wird für den Rest des Tutorials die Arbeitsumgebung sein, da auf eine grafische Benutzeroberfläche verzichtet werden kann. Die Performance ist in der Konsole zudem deutlich besser.

% FIXME: Bild von Terminal

\subsection{Root-Rechte erlangen}
Die meisten der in dieser Anleitung beschriebenen Befehle verlangen erweiterte Rechte. Diese können unter Raspbian ganz einfach erlangt werden:

\begin{lstlisting}
sudo su
\end{lstlisting}

Ein paar Informationen zum Gebrauch der Konsole (Arbeitsumgebung): 

\begin{itemize}
\item Ein Befehl wird mittels Drücken der ``Enter-Taste" abgesetzt
\item Bevor ein neuer Befehl abgsetzt werden, muss der zuvor eingegebene abgeschlossen sein
\item Gross- und Kleinschreibung werden unter Linux unterschieden!
\item Immer sicherstellen, dass der Befehl auch wirklich richtig eingegeben wurde
\end{itemize}

\subsection{System aktualisieren}
Um sicher zu stellen, dass das System auf dem aktuellsten Stand ist, müssen zuerst alle installierten Pakete aktualisiert werden.
\\
Folgende Befehle müssen dazu abgesetzt werden:

\begin{lstlisting}
apt-get update
apt-get upgrade
\end{lstlisting}

Nach der Eingabe von ``apt-get upgrade" fragt das Terminal noch einmal nach, ob man die neuen, zur Verfügung stehenden Pakete wirklich installieren will. Standardmässig ist die Antwort auf "Ja" eingestellt, was man an dem grossen Y in [Y/n] erkennt. Um fortzufahren reicht ein erneutes Drücken der ``Enter-Taste". Zukünftige Rückfragen bei abgesetzten Befehlen können auf die gleiche Weise behandelt werden.

\subsection{Abhänigkeiten installieren}
Damit ownCloud reibungslos laufen kann, müssen einige zusätzliche Pakete installiert werden.

Wir benötigen: 
\begin{itemize}
\item Apache2 (Webserver)
\item PHP5 (Skriptsprache)
\item SQLite (Datenbank)
\end{itemize}

Der folgenden Befehl kann entweder kopiert und ins Terminal eingefügt oder aber abgetippt werden. Je nach verwendetem PDF-Betrachter, muss auf die 2. Methode zurückgegriffen werden:

\begin{lstlisting}
sudo apt-get install apache2 php5 php5-gd php5-sqlite php5-curl php5-json php5-common php5-intl php-pear php-apc php-xml-parser libapache2-mod-php5 curl libcurl3 libcurl3-dev sqlite
\end{lstlisting}

\subsection{Statische IP-Adresse}
Die IP-Adresse, durch welche der Computer im Netz eindeutig identifiziert werden kann und über welche letztendlich der Zugriff auf die Cloud erfolgen wird, kann nach jedem Computerstart anderst aussehen.
Aus diesem Grund ist es sinnvoll, dass die IP-Adresse statisch festgelegt wird und somit immer gleich bleibt.

Zuerst muss die Netwerkkonfigurationsdatei unter ``/etc/network/interfaces'' angepasst werden.
\\
Dazu einfach die Datei mit einem Texteditor öffnen:

\begin{lstlisting}
sudo nano /etc/network/interfaces
\end{lstlisting} 

Und folgende Zeilen anfügen:
\begin{lstlisting}
iface eth0 inet static
address 192.168.1.99
netmask 255.255.255.0
gateway 192.168.1.1
network 192.168.1.0
broadcast 192.168.1.255
\end{lstlisting}

% FIXME: iface eth0 inet dhcp ersetzen (standardmässig in file & auf default gesetzt)?
% Lösung: sed -i 's/iface eth0 inet dhcp/;iface eth0 inet dhcp' /etc/network/interfaces ??  
    
Die verwendete IP-Adresse in der zweiten Zeile (192.168.1.99) sollte durch die aktuelle IP-Adresse des Systems ersetzt werden, sofern nichts anderes gewünscht wird. Diese kann mit dem Kommando ``ifconfig'', welches in ein Terminal eingegeben wird, ermittelt werden. Sie steht auf der zweiten Zeile bei eth0 unter ``inet addr:".

% FIXME: Screenshot?

Nun muss das Interface noch neu gestartet werden, damit die Änderungen wirksam werden:

\begin{lstlisting}
ifdown eth0
ifup eth0
\end{lstlisting}

\subsection{Webserver-Benutzer anlegen}
Aus Sicherheitsgründen sollte ein Webserver immer von einem Benutzer mit eingeschränkten Rechten ausgeführt werden. Er soll nur auf jene Dateien zugreifen können, die er auch wirklich braucht. Dazu legt man einen Benutzer namens ``www-data' an und fügt ihn anschliessend der gleichnamigen Gruppe zu:

\begin{lstlisting}
groupadd www-data
usermod -a -G www-data www-data
\end{lstlisting}

Nach dem Befehl ``groupadd" wird unter Umständen eine Meldung angezeigt, dass die angegebene Gruppe ``www-data" bereits existiert. In diesem Fall einfach mit dem zweiten Befehl weiterfahren.

\subsection{Webserver konfigurieren}
Als Webserver wird apache2 verwendet. Dieser wurde bereits im Abschnitt ``Abhängigkeiten installieren'' installiert. Er muss jetzt lediglich noch so eingerichtet werden, 
dass ownCloud darauf laufen kann.

Apache verlangt beim Start zu wissen, wie der Webserver heisst. Man hat hier freie Wahl, sollte aber etwas Sinnvolles eingeben, wie beispielsweise ``owncloud''.
\\
Jetzt muss der Name noch der Konfigurationsdatei von Apache hinzgefügt werden:

\begin{lstlisting}
echo "ServerName owncloud" >> /etc/apache2/apache2.conf
\end{lstlisting}

Auch dem System selbst muss dieser Namen bekannt gegeben werden. Folgender Befehl fügt die entsprechende Zeile der Datei ``/etc/hosts'' hinzu:

\begin{lstlisting}
echo "127.0.0.1 ownloud" >> /etc/hosts
\end{lstlisting}

% 127.0.0.1 localhost existiert standardmässig im hosts file, was tun?

Damit owncloud korrekt ausgeführt werden darf, müssen ihm noch gewisse Rechte eingeräumt werden. Dazu öffnet man die Apache Konfigurationsdatei ``/etc/apache2/sites-enabled/000-default'' mit einem Texteditor:

\begin{lstlisting}
nano /etc/apache2/sites-enabled/000-default
\end{lstlisting}

Und sucht nach folgendem Abschnitt:

\begin{lstlisting}
<Directory /var/www/>
  Options Indexes FollowSymLinks MultiViews
  AllowOverride None
  Order allow,deny
  allow from all
</Directory>
\end{lstlisting}

Dort muss man die Zeile ``AllowOverride None'' mit ``AllowOverride All'' ersetzen. Zum Schluss müssen noch ein paar zusätzliche Module für den Webserver installiert werden:

\begin{lstlisting}
a2enmod rewrite
a2enmod headers
\end{lstlisting}

\subsection{Webserver absichern}
Ein grosses Thema in Sachen Cloud ist die Sicherheit. Die zukünftige Cloud soll dabei nicht zu kurz kommen, weshalb der Webserver mit HTTPS\footnote{\url{http://de.wikipedia.org/wiki/Https}} ausgestattet wird.
\\
\\
Zuerst muss ein Zertifikat mit Schlüssel generiert und in ein bestimmtes Verzeichnis abgelegt werden, damit der Webserver es auch finden kann.
\\
Folgende Befehle müssen abgesetzt werden:

\begin{lstlisting}
mkdir -p /etc/apache2/ssl
openssl req -new -x509 -days 365 -nodes -out /etc/apache2/ssl/apache.pem -keyout /etc/apache2/ssl/apache.pem
ln -sf /etc/apache2/ssl/apache.pem /etc/apache2/ssl/`/usr/bin/openssl x509 -noout -hash < /etc/apache2/ssl/apache.pem`
chmod 600 /etc/apache2/ssl/apache.pem
\end{lstlisting}

% FIXME: test if apache listen on port 443 per default

Nach der Erstellung des Zertifikates, muss das Modul geladen werden, welches der Cloud SSL (HTTPS) zur Verfügung stellt:

\begin{lstlisting}
a2enmod ssl
echo "<virtualhost *:443>
  SSLEngine On
  SSLCertificateFile /etc/apache2/ssl/apache.pem
  DocumentRoot /var/www
</virtualhost>" >> /etc/apache2/sites-available/ssl
a2ensite ssl
\end{lstlisting}

% Nano statt echo?? 

\subsection{PHP konfigurieren}
PHP hat standardmässig ein Sicherheitslimit gesetzt, welches die Uploadgrösse einer Datei einschränkt. Diese soll nun aber erhöht werden, damit der Anwender der Cloud in der Lage ist, Dateien hochzuladen, die grösser als 2 Megabyte sind.

\begin{lstlisting}
sed -i 's/upload_max_filesize = 2M/upload_max_filesize = 2G/' /etc/php5/apache2/php.ini
sed -i 's/post_max_size = 8M/post_max_size = 2G/' /etc/php5/apache2/php.ini
\end{lstlisting}

\subsection{ownCloud installieren}
Jetzt ist der Webserver bereit, um ownCloud zu installieren. Zuerst muss die neuste Version von ownCloud heruntergeladen werden. Um herauszufinden, welches die neuste Version ist, besucht man am besten die offizielle Homepage\footnote{\url{https://owncloud.org/}} oder Wikipedia. Zur Zeit ist Version 6.0.1 die neuste. Sie kann wie folgt direkt aus dem Terminal heruntergeladen werden:

\begin{lstlisting}
cd
wget http://download.owncloud.org/community/owncloud-6.0.1.tar.bz2 -O owncloud.tar.bz2
\end{lstlisting}

Nun muss das heruntergeladene Archiv noch entpackt werden und die Dateien in den Ordner ``/var/www'' verschoben werden. Dieser Ordner ist standardmässig der vom Webserver benutzte.

\begin{lstlisting}
tar xvf owncloud.tar.bz2
rm -f /var/www/index.html
mv owncloud/* /var/www
mv owncloud/.htaccess /var/www
rm -rf owncloud owncloud.tar.bz2
\end{lstlisting}

%FIXME: rm -f /var/www.index.html nach mit anderen rm gruppieren? --> verwechslungsgefahr mit index.php??

Damit der zuvor erstellte Benutzer ``www-data'' auch auf diese Dateien zugreifen kann, müssen ihm noch die entsprechenden Rechte gegeben werden:

\begin{lstlisting}
chown -R www-data:www-data /var/www
\end{lstlisting}

\subsection{Speicher erweitern}
Da die verwendete SD-Karte eine eher kleine Kapazität hat, lohnt es sich, ownCloud mehr Speicher zur Verfügung zu stellen. Man kann dazu einfach eine externe Festplatte per USB oder alternativ einen USB-Stick an den Raspberry anschliessen und anschliessend konfigurieren.

Zuerst muss man den Namen des Angeschlossenen Speichergerätes herausfinden: 

\begin{lstlisting}
blkid
\end{lstlisting}

Dieser Befehl gibt alle angeschlossenen Speichergeräte an. Wenn neben der SD-Karte lediglich ein zusätzliche Speichergerät angeschlossen wurde, müsste dieses als drittes mit ``dev/sda1" aufgeführt sein

\subsubsection{Separater Speicher}
Wird ein neues oder leeres Speichergerät verwendet, muss es zuerst neu formatiert werden (hier mit dem Dateisystem ext4). Dies löscht alle auf dem Speichergerät vorhandenen Daten!

\begin{lstlisting}
mkfs.ext4 /dev/sda1
\end{lstlisting}

\subsubsection{Automatisches Einbinden}
Damit die Festplatte bei jedem Neustart automatisch eingebunden (aktiviert) wird und zur Verfügung steht, muss das System dementsprechend konfiguriert werden. 

\begin{lstlisting}
mkdir -p /mnt/ownclouddata
\end{lstlisting}

\begin{lstlisting}
blkid /dev/sda1
\end{lstlisting}

Den Wert nach TYPE zwischen den Anführungszeichen muss man sich merken. Es handelt sich um den Namen des verwendeten Dateisystems auf dem Datenträger.
Bevor der nachfolgenden Befehl ausgeführt werden kann, muss das Wort TYPE durch den vorhin gemerkten Wert - das verwendete Dateisystem - ersetzt werden.

\begin{lstlisting}
echo "/dev/sdb1 /mnt/ownclouddata TYPE defaults 0 0" >> /etc/fstab
\end{lstlisting}

Nun muss noch die Festplatte in das System eingebunden und dem Benutzer ``www-data'' die entsprechenden Rechte gegeben werden:

\begin{lstlisting}
mount -a
chown -R www-data:www-data /mnt/ownclouddata
\end{lstlisting}

\subsection{Webserver neustarten}
Zu guter letzt muss der Webserver neu gestartet werden, damit die Änderungen wirksam werden:

\begin{lstlisting}
service apache2 restart
\end{lstlisting}
