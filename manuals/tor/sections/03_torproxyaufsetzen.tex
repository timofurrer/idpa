\section{WiFi Adapter teste}
Um zu schauen ob wir nun einen Raspberry Pi kompatiblen WiFi Adapter gekauft haben oder nicht, stecken wir den Adapter in den USB-Port, warten einen Moment und rufen anschliessend folgendes Kommando auf:

\begin{lstlisting}
ifconfig -a
\end{lstlisting}

Wenn wir auf der, nun erschienen, Ausgabe einen Eintrag für \textit{wlan0} sehen, können wir mit der Einrichtung des Access Points beginnen.

\section{WiFi Access Point einrichten}
Wie vielleicht bemerkt haben wir nun zwei Schnittstellen um uns mit dem Internet zu verbinden. Einmal per Netzwerkkabel und einmal per WiFi Adapter.
Das Netzwerkkabel dient hier dazu den Raspberry Pi mit dem Internet zu verbinden und der WiFi Adapter wird verwendet um ein lokales Wlan einzurichten. Diese Funktionalität ist im Prinzip die gleiche, wie sie wahrscheinlich auch unser Router zur Verfügung stellt. 
Hierzu benötigen wir einen eigenen DHCP-Server, welcher auf unserem Wlan eingerichtet ist und dafür verantwortlich ist, dass dieser Computer, der sich mit diesem Wlan verbindet eine valide IP-Adresse erhält und somit ein Teil des Netzes wird.

Dieser und ein Tool, welches als \textit{Access Point} selbst dient, müssen durch folgenden Befehl installiert werden:

\begin{lstlisting}
apt-get install hostapd isc-dhcp-server
\end{lstlisting}

\subsection{DHCP Server konfigurieren}
Damit der DHCP Server richtig funktionieren kann, muss dieser zuerst ein wenig konfiguriert werden.
Dazu öffnen wir die Datei \textit{/etc/dhcp/dhcpd.conf}.

\begin{lstlisting}
nano /etc/dhcp/dhcpd.conf
\end{lstlisting}

Zuerst müssen die folgenden Zeile gefunden und mit einer vorangestellten Raute (\#) auskommentiert werden:

\begin{lstlisting}
option domain-name "example.org"
option domain-name-server ns1.example.org,ns2.example.org
\end{lstlisting}

Neu sieht das ganze folgendermassen aus:

\begin{lstlisting}
#option domain-name "example.org"
#option domain-name-server ns1.example.org,ns2.example.org
\end{lstlisting}

Als nächstes muss dem DHCP Server gesagt werden, dass er der offizielle DHCP Server dieses Netzes ist. Dies hat zur Folge, dass er auf DHCPRequests eines Clients eine IP Adresse zurück gibt.
Dazu suchen wir folgende Zeile:

\begin{lstlisting}
#authoritative;
\end{lstlisting}

und machen daraus:

\begin{lstlisting}
authoritative;
\end{lstlisting}

Nun fügen wir noch folgende Zeilen am Ende der Datei ein, um damit unser Netz zu konfigurieren:

\begin{lstlisting}
subnet 192.168.66.0 netmask 255.255.255.0 {
  range 192.168.42.10 192.168.42.50;
  option broadcast-address 192.168.66.255;
  option routers 192.168.66.1;
  default-lease-time 666;
  max-lease-time 7200;
  option domain-name "local";
  option domain-name-servers 8.8.8.8, 8.8.4.4;
}
\end{lstlisting}

Den DHCP Server ist nun fertig konfiguriert. Jedoch muss man ihn nun noch an ein Netwerkinterface binden. Dieses Netzwerkinterface ist in unserem Fall wlan0 wie wir zu anfang ausfindig machen konnten.

In der Datei \textit{/etc/default/isc-dhcp-server} muss bei der Einstellung \textit{INTERFACES} wlan0 eingetragen werden:

\begin{lstlisting}
INTERFACES="wlan0"
\end{lstlisting}

Unserem \textit{wlan0} Interface kann jetzt eine statische IP-Adresse vergeben wird. Und zwar jene, die wir bei der DHCP Server Konfiguration bei der Subnetzoption \textit{routers} angegeben haben. \\
In der Datei \textit{/etc/network/interfaces} ändern wir folgende Zeilen:

\begin{lstlisting}
iface wlan0 inet manual
wpa-roam: /etc/etc/wpa_supplicant/wpa_supplicant.conf
iface default inet dhcp
\end{lstlisting}

Durch folgendes:

\begin{lstlisting}
iface wlan0 inet static
  address 192.168.66.1
  netmask 255.255.255.0
\end{lstlisting}

Da dieses Interface bereits gestartet ist, kann man mit folgendem Befehl im laufenden Betrieb eine statische IP-Adresse vergeben:

\begin{lstlisting}
ifconfig wlan0 192.168.66.1
\end{lstlisting}

\subsection{Hostapd konfigurieren}
Weiter geht es darum den Access Point selbst einzurichten. Das verwendete Tool hostapd haben wir bereits installiert.
Die Datei \textit{/etc/hostapd/hostapd.conf} muss erstellt und folgendes eingetragen werden:

\begin{lstlisting}
interface=wlan0
driver=r8712u
ssid=PiProxy
hw_mode=g
channel=6
macaddr_acl=0
auth_algs=1
ignore_broadcast_ssid=0
wpa=2
wpa_passphrase=pi
wpa_key_mgmt=WPA-PSK
wpa_pairwise=TKIP
rsn_pairwise=CCMP
\end{lstlisting}

Der Treiber ist je nach verwendetem WiFi Adapter anders. Was bedeutet, dass dieser zuerst ausfindig gemacht werden muss. \\

Diese nun erstellte Konfiguration muss \textit{hostapd} bekannt gemacht werden. In der Datei \textit{/etc/default/hostapd.conf} muss nach \textit{DAEMON\_CONF} gesucht und diese Zeile wie folgt geändert werden:

\begin{lstlisting}
DAEMON_CONF="/etc/hostapd/hostapd.conf"
\end{lstlisting}

Der Raspberry Pi ist nun soweit ein WiFi Netzwerk erstellen und sich mit dem Internet verbinden zu können. Was noch fehlt ist die Verbindung zwischen dem WiFi-Netz und dem Internet.

\subsection{NAT konfigurieren}
NAT wird gebraucht um die Clients vom WiFi-Netz auf das Internet zu leiten.

Zuerst wird der Datei \textit{/etc/sysctl.conf} folgendes am Ende angefügt:

\begin{lstlisting}
net.ipv4.ip_forward=1
\end{lstlisting} 

Und danach soll noch folgendes ausgeführt werden, um das Weiterleiten im laufenden Betrieb vom System zu aktivieren:

\begin{lstlisting}
echo 1 > /proc/sys/net/ipv4/ip_forward
\end{lstlisting}

Weiter muss die Firewall entsprechend angepasst werden, damit NAT das eingerichtet Forwarding ausführen kann.
Dazu folgende Befehle ausführen:

\begin{lstlisting}
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
iptables -A FORWARD -i eth0 -o wlan0 -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -A FORWARD -i wlan0 -o eth0 -j ACCEPT
\end{lstlisting}

Damit man diese Befehle nicht bei jedem Neustart des Raspberry Pi's eingeben muss, speichern wir diese mit folgendem Befehl permanent:

\begin{lstlisting}
iptables-save > /etc/iptables.ipv4.nat
echo "up iptables-restore < /etc/iptables.ipv4.net" >> /etc/network/interfaces
\end{lstlisting}


